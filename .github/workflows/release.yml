name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: bun-darwin-arm64
            assets: "dramacode-darwin-arm64.zip DRAMACODE-mac-arm64.dmg"
          - os: macos-latest
            target: bun-darwin-x64
            assets: "dramacode-darwin-x64.zip DRAMACODE-mac-x64.dmg"
          - os: windows-latest
            target: bun-windows-x64
            assets: "dramacode-windows-x64.zip"

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install target sqlite-vec
        run: |
          TARGET="${{ matrix.target }}"
          VEC_OS="${TARGET#bun-}"
          VEC_OS="${VEC_OS%-*}"
          VEC_ARCH="${TARGET##*-}"
          if [ "$VEC_OS" = "win32" ]; then VEC_OS="windows"; fi
          bun add "sqlite-vec-${VEC_OS}-${VEC_ARCH}" --no-save 2>/dev/null || true
        shell: bash

      - name: Build
        run: bun run scripts/build.ts ${{ matrix.target }}
        env:
          VERSION: ${{ github.ref_name }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: |
            *.zip
            *.dmg

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | head -20

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.dmg
